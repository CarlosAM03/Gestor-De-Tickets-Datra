// ================================
// Prisma Schema — Gestor de Tickets Datra
// Versión: Sprint 3 (Producción Ready)
// Fecha: 22-Dic-2025
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// ENUMS
// ================================

// Estados de Ticket
enum TicketStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  RESOLVED
  CLOSED
  CANCELLED
}

enum UserRole {
  ADMIN
  TECNICO
  INGENIERO
}

enum ImpactLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum ClientType {
  INTERNO
  EXTERNO
}

// ================================
// MODELS
// ================================

model User {
  id       Int      @id @default(autoincrement())
  name     String
  email    String   @unique
  password String
  role     UserRole @default(TECNICO)
  active   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  ticketsCreated    Ticket[] @relation("TicketCreatedBy")
  ticketsClosed     Ticket[] @relation("TicketClosedBy")
  ticketsPreliminar Ticket[] @relation("TicketPreliminaryBy")
  ticketsDeleted    Ticket[] @relation("TicketDeletedBy")

  // Auditoría
  ticketHistory TicketHistory[]
}

// ================================
// CLIENTE (NUEVO — DEFINITIVO)
// ================================

model Client {
  /// RFC es el identificador único del cliente
  rfc String @id

  companyName  String
  businessName String?
  location     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tickets Ticket[]
}

// ================================
// TICKET
// ================================

model Ticket {
  id   Int    @id @default(autoincrement())
  code String @unique

  // Información general
  openedAt DateTime     @default(now())
  status   TicketStatus @default(OPEN)

  requestedBy String?
  contact    String?
  clientType ClientType?

  // =========================
  // CLIENTE
  // =========================
  clientRfc String?
  client    Client? @relation(fields: [clientRfc], references: [rfc])

  // =========================
  // Incidente
  // =========================
  serviceAffected String?
  problemDesc     String?
  eventLocation   String?
  estimatedStart  DateTime?
  impactLevel     ImpactLevel?

  // =========================
  // Diagnóstico
  // =========================
  initialFindings   String?
  probableRootCause String?

  // =========================
  // Cierre
  // =========================
  actionsTaken     String?
  closedAt         DateTime?
  serviceStatus    String?
  additionalNotes  String?
  correctiveAction Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // =========================
  // Soft delete & control
  // =========================
  deleteRequested Boolean  @default(false)
  deletedAt       DateTime?
  deletedById     Int?
  deletedBy       User? @relation("TicketDeletedBy", fields: [deletedById], references: [id])

  // =========================
  // Relaciones de usuarios
  // =========================
  createdById Int?
  createdBy   User? @relation("TicketCreatedBy", fields: [createdById], references: [id])

  preliminaryById Int?
  preliminaryBy   User? @relation("TicketPreliminaryBy", fields: [preliminaryById], references: [id])

  closingTechnicianId Int?
  closingTechnician   User? @relation("TicketClosedBy", fields: [closingTechnicianId], references: [id])

  // Auditoría
  history TicketHistory[]
}

// ================================
// HISTORIAL DE TICKET (AUDITORÍA)
// ================================

model TicketHistory {
  id Int @id @default(autoincrement())

  // =========================
  // Relaciones
  // =========================
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  /// Snapshot del RFC del cliente para auditoría y filtros
  clientRfc String?

  action    String
  fromValue String?
  toValue   String?

  performedById Int?
  performedBy   User? @relation(fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  // Índices recomendados para auditoría futura
  @@index([ticketId])
  @@index([clientRfc])
  @@index([createdAt])
}
